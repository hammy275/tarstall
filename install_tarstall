#!/usr/bin/python3

import sys
import os
from subprocess import call
from shutil import which, rmtree

columns = int(os.popen('stty size', 'r').read().split()[1])

def status(msg):
    print("#"*int(columns*0.75))
    print(msg)
    print("#"*int(columns*0.75))


def run(cmds):
    err = call(cmds)
    return err == 0


def install_package(pkg, is_different=False):
    if is_different:
        if which("apt") is not None or which("apt-get") is not None:
            pkg = pkg["apt"]
        elif which("dnf") is not None:
            pkg = pkg["dnf"]
        else:
            status("This script only supports automatic program installtion through apt(-get), dnf, and pip; please install {} manually!".format(pkg))
            sys.exit(1)
    if which("apt") is not None:
        run(["sudo", "apt", "install", pkg, "-y"])
    elif which("apt-get") is not None:
        run(["sudo", "apt-get", "install", pkg, "-y"])
    elif which("dnf") is not None:
        run(["sudo", "dnf", "install", pkg, "-y"])
    else:
        status("This script only supports automatic program installtion through apt(-get), dnf, and pip; please install {} manually!".format(pkg))
        sys.exit(1)


def setup():
    # Checks
    status("Checking for anything missing for tarstall setup")
    supported_package_managers = ["apt", "apt-get", "dnf"]
    if which("sudo") is None:
        status("Please install 'sudo'!")
        sys.exit(1)
    supported = False
    for manager in supported_package_managers:
        if which(manager) is not None:
            supported = True
            break
    if not supported:
        status("You currently don't have a supported package manager! Currently supported package managers are: " + ", ".join(supported_package_managers))
        sys.exit(1)
    print("All of the checks passed!\nStarting tarstall installation...")

    # Install git
    status("Installing git")
    install_package("git")

    # Clone repository
    status("Getting a copy of tarstall")
    try:
        rmtree("/tmp/tarstall-setup")
    except FileNotFoundError:
        pass
    os.mkdir("/tmp/tarstall-setup")
    os.chdir("/tmp/tarstall-setup")
    if not run(["git", "clone", "https://github.com/hammy3502/tarstall.git"]):
        status("Error while getting the tarstall repository!")
        try:
            rmtree("/tmp/tarstall-setup")
        except FileNotFoundError:
            pass
        sys.exit(1)
    os.chdir("/tmp/tarstall-setup/tarstall")

    # Install requirements
    status("Installing tarstall's requirements")
    if not run([sys.executable, "-m", "pip", "install", "-r", "requirements.txt", "--user"]):
        install_package("python3-pip")
    if not run([sys.executable, "-m", "pip", "install", "-r", "requirements.txt", "--user"]) or not \
    run([sys.executable, "-m", "pip", "install", "-r", "requirements-gui.txt", "--user"]):
        status("An error occured while installing the GUI requirements!")
        sys.exit(1)

    # Test tkinter (since we can't install it through pip)
    status("Installing tkinter")
    try:
        import tkinter
        del tkinter
        print("Thanks for having tkinter already installed!")
    except ImportError:
        install_package({"apt": "python3-tk", "dnf": "python3-tkinter"}, True)

    # Pass control to tarstall
    status("Running tarstall installation")
    run([sys.executable, "./tarstall_execs/tarstall", "-f"])

    # Removing tarstall setup directory
    try:
        rmtree("/tmp/tarstall-setup")
    except FileNotFoundError:
        pass

if __name__ == "__main__":
    setup()